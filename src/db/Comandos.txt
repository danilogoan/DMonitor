#deletando a DATABASE
DROP DATABASE DMONITORDB;

##############
# Criando DB #
##############
CREATE DATABASE DMonitorDB;
USE DMonitorDB;


###################
# Criando Tabelas #
###################
CREATE TABLE EMPRESA(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

NOMEFANTASIA VARCHAR(30) NOT NULL,
RAZAOSOCIAL VARCHAR(30) NOT NULL,
CNPJ VARCHAR(14) UNIQUE NOT NULL
);

CREATE TABLE USUARIO(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

NOME VARCHAR(30) NOT NULL,
EMAIL VARCHAR(30) NOT NULL UNIQUE,
NASCIMENTO DATE NOT NULL,

ID_EMPRESA INT NOT NULL,
FOREIGN KEY(ID_EMPRESA)
REFERENCES EMPRESA(ID)
);

CREATE TABLE LOGIN(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

MATRICULA VARCHAR(9) NOT NULL UNIQUE,
SENHA VARCHAR(30) NOT NULL,
ACESSO INT NOT NULL,

ID_USUARIO INT NOT NULL,
FOREIGN KEY(ID_USUARIO)
REFERENCES USUARIO(ID)
);

CREATE TABLE ENDERECO(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

TIPO VARCHAR(10) NOT NULL,
LOGRADOURO VARCHAR(30) NOT NULL,
NUMERO VARCHAR(6) NOT NULL,
COMPLEMENTO VARCHAR(30),
CEP VARCHAR(8) NOT NULL,
CIDADE VARCHAR(30) NOT NULL,
ESTADO VARCHAR(30) NOT NULL,
PAIS VARCHAR(30) NOT NULL,

ID_EMPRESA INT NOT NULL,
FOREIGN KEY(ID_EMPRESA)
REFERENCES EMPRESA(ID)
);

CREATE TABLE TELEFONE(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

DDD VARCHAR(5) NOT NULL,
NUMERO VARCHAR(10) NOT NULL,

ID_USUARIO INT,
FOREIGN KEY(ID_USUARIO)
REFERENCES USUARIO(ID),
ID_EMPRESA INT,
FOREIGN KEY(ID_EMPRESA)
REFERENCES EMPRESA(ID)
);

CREATE TABLE RESERVATORIO(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

TIPO VARCHAR(30) NOT NULL,
CAPACIDADE VARCHAR(30) NOT NULL,

ID_EMPRESA INT NOT NULL,
FOREIGN KEY(ID_EMPRESA)
REFERENCES EMPRESA(ID)
);

CREATE TABLE METRICAS(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

NIVEL DOUBLE NOT NULL,
VAZAO DOUBLE NOT NULL,

ID_RESERVATORIO INT NOT NULL,
FOREIGN KEY(ID_RESERVATORIO)
REFERENCES RESERVATORIO(ID)
);

CREATE TABLE VALVULAS(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

ESTADO INT NOT NULL,

CHECK(ESTADO>=0),
CHECK(ESTADO<=100),

ID_RESERVATORIO INT NOT NULL,
FOREIGN KEY(ID_RESERVATORIO)
REFERENCES RESERVATORIO(ID)
);

CREATE TABLE INCIDENTES(
ID INT PRIMARY KEY AUTO_INCREMENT,
IDATA DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

DATA DATE NOT NULL,
OCORRENCIA VARCHAR(100) NOT NULL,
SETOR VARCHAR(30),

ID_USUARIO INT NOT NULL,
FOREIGN KEY(ID_USUARIO)
REFERENCES USUARIO(ID),
ID_EMPRESA INT NOT NULL,
FOREIGN KEY(ID_EMPRESA)
REFERENCES EMPRESA(ID)
);

############################
# Observar Tabelas Criadas #
############################
SHOW TABLES;
# descrição #
DESC EMPRESA;
DESC ENDERECO;
DESC INCIDENTES;
DESC LOGIN;
DESC METRICAS;
DESC RESERVATORIO;
DESC USUARIO;
DESC TELEFONE;
DESC VALVULAS;

########################
# Populando as Tabelas #
########################
# Empresa X com Endereço e Telefone
INSERT INTO EMPRESA(NOMEFANTASIA,RAZAOSOCIAL,CNPJ) VALUES('X','EMPRESAX','01234567891234');
INSERT INTO ENDERECO(TIPO, LOGRADOURO, NUMERO, COMPLEMENTO, CEP, CIDADE, ESTADO, PAIS, ID_EMPRESA)
VALUES('Rua', 'Sete de Setembro', '19', '1010', '15487236', 'Campina Grande', 'Paraiba', 'Brasil', 1);
INSERT INTO TELEFONE(DDD, NUMERO, ID_EMPRESA) VALUES('83','32541258', 1);

# Empresa Z com Endereço e Telefone
INSERT INTO EMPRESA(NOMEFANTASIA,RAZAOSOCIAL,CNPJ) VALUES('Z','EMPRESAZ','17648418416790');
INSERT INTO ENDERECO(TIPO, LOGRADOURO, NUMERO, CEP, CIDADE, ESTADO, PAIS, ID_EMPRESA)
VALUES('Avenida', 'Epitacio Pessoa', '6125', '25412536', 'João Pessoa', 'Paraiba', 'Brasil', 2);
INSERT INTO TELEFONE(DDD, NUMERO, ID_EMPRESA) VALUES('83','98547265', 2);

# Empresa Y com Endereço e Telefone
INSERT INTO EMPRESA(NOMEFANTASIA,RAZAOSOCIAL,CNPJ) VALUES('Y','EMPRESAY','43210987654321');
INSERT INTO ENDERECO(TIPO, LOGRADOURO, NUMERO, COMPLEMENTO, CEP, CIDADE, ESTADO, PAIS, ID_EMPRESA)
VALUES('Avenue', 'Champs-Élysées', '2514', '102A', '85214527', 'Paris', 'Paris', 'França', 3);
INSERT INTO TELEFONE(DDD, NUMERO, ID_EMPRESA) VALUES('+331','44111030', 3);

########################
# Adicionando Usuários #
########################
# Da Empresa X
INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Julio','julio@dmonitor.x.com','1992-04-04', 3);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('+331','48574124', 1);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00100X001','J1225',1,1);

INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Larissa','larissa@dmonitor.x.com','1996-11-06', 1);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('83','952148752', 2);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00100X002','L1234',1,2);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00200X002','L12345*',2,2);

INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('João','joao@dmonitor.x.com','1998-10-16', 1);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('83','40028922', 3);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00200X003','J4321*',2,3);

# Da Empresa z
INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Ana','ana@dmonitor.z.com','1997-12-14', 2);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('83','920154785', 4);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00100Z004','A4321',1,4);

INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Rhuan','rhuan@dmonitor.z.com','1990-06-01', 2);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('83','910458752', 5);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00100Z005','A4321',1,5);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00200Z005','A43215*',2,5);

INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Danilo','danilo@dmonitor.z.com','1998-08-21', 2);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('83','998574521', 6);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00200Z006','D4315*',2,6);

# Da Empresa Y
INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Guilherme','guilherme@dmonitor.y.com','1991-02-07', 3);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('+331','41587521', 7);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00100Y007','G0702',1,7);

INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('Anthony','anthony@dmonitor.y.com','1991-05-10', 3);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('+331','48752369', 8);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00100Y008','A1005',1,8);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00200Y008','A1005*',2,8);

INSERT INTO USUARIO(NOME, EMAIL, NASCIMENTO, ID_EMPRESA)
VALUES('José','jose@dmonitor.y.com','1990-01-01', 3);
INSERT INTO TELEFONE(DDD, NUMERO, ID_USUARIO) VALUES('83','995874521', 9);
INSERT INTO LOGIN(MATRICULA, SENHA, ACESSO, ID_USUARIO)
VALUES('00200Y009','J1234*',2,9);

#############################
# Adicionando Reservatórios #
#############################
# Da Empresa X
INSERT INTO RESERVATORIO(TIPO, CAPACIDADE, ID_EMPRESA)
VALUES('Gasolina', '3000 litros', 1);
INSERT INTO RESERVATORIO(TIPO, CAPACIDADE, ID_EMPRESA)
VALUES('Óleo Combustível', '3000 litros', 1);

# Da Empresa Z
INSERT INTO RESERVATORIO(TIPO, CAPACIDADE, ID_EMPRESA)
VALUES('Petróleo', '6000 litros', 2);
INSERT INTO RESERVATORIO(TIPO, CAPACIDADE, ID_EMPRESA)
VALUES('Óleo Lubrificante', '3000 litros', 2);

# Da Empresa Y
INSERT INTO RESERVATORIO(TIPO, CAPACIDADE, ID_EMPRESA)
VALUES('Querosene', '3000 litros', 3);
INSERT INTO RESERVATORIO(TIPO, CAPACIDADE, ID_EMPRESA)
VALUES('Resíduos', '2000 litros', 3);

####################################
# Adicionando Leituras dos Valores #
####################################
# Primeira Leitura
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',100,1);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',100,2);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',0,3);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',0,4);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',60,5);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',100,6);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',500,10,1);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',700,10,2);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',4000,0,3);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',1500,0,4);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',1000,30,5);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:10:30',100,5,6);

# Segunda Leitura
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',100,1);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',50,2);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',0,3);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',0,4);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',60,5);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',100,6);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',510,10,1);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',710,5,2);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',4000,0,3);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',1500,0,4);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',1030,30,5);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:11:30',105,5,6);

# Terceira Leitura
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',100,1);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',100,2);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',50,3);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',10,4);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',0,5);
INSERT INTO VALVULAS(IDATA, ESTADO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',100,6);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',520,10,1);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',715,10,2);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',3995,-50,3);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',1501,20,4);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',1060,0,5);
INSERT INTO METRICAS(IDATA, NIVEL, VAZAO, ID_RESERVATORIO) VALUES('2021-09-22 08:12:30',110,5,6);

#############################
# Adicionando os Incidentes #
#############################
# Da Empresa X
INSERT INTO INCIDENTES(DATA, OCORRENCIA, SETOR, ID_USUARIO, ID_EMPRESA)
VALUES('2021-09-04','Defeito na válvula do reservatório de Gasolina', 'Válvulas', 2, 1);
INSERT INTO INCIDENTES(DATA, OCORRENCIA, ID_USUARIO, ID_EMPRESA)
VALUES('2021-09-10','Funcionário escorregou e se machucou', 1, 1);

# Da Empresa Z
INSERT INTO INCIDENTES(DATA, OCORRENCIA, SETOR, ID_USUARIO, ID_EMPRESA)
VALUES('2021-08-07','Reservatório de petróleo caiu ao ser transportado', 'Reservatórios', 6, 2);
INSERT INTO INCIDENTES(DATA, OCORRENCIA, ID_USUARIO, ID_EMPRESA)
VALUES('2021-08-15','1000 litros de petróleo foram desperdiçados', 6, 2);
INSERT INTO INCIDENTES(DATA, OCORRENCIA, ID_USUARIO, ID_EMPRESA)
VALUES('2021-09-10','Falta de energia na empresa', 4, 2);

# Da Empresa Y
INSERT INTO INCIDENTES(DATA, OCORRENCIA, ID_USUARIO, ID_EMPRESA)
VALUES('2021-09-23','O reservatório de Querosene explodiu', 8, 3);

#########################
# Operações de Consulta #
#########################
# 1) Qual reservatório tem o nível mais alto?
# Considerando as leituras, deve-se pegar as últimas leituras para saber o nível
# atual dos reservatórios, assim pode-se pegar o maior nível dentre aquelas
# leituras e exibir o reservatório indicando o id da empresa, o nome da empresa,
# o reservatório e o seu nível
SELECT E.ID, E.NOMEFANTASIA, R.TIPO, MM.MAXNIVEL FROM EMPRESA E
INNER JOIN RESERVATORIO R
ON E.ID = R.ID_EMPRESA
INNER JOIN METRICAS M
ON R.ID = M.ID_RESERVATORIO
INNER JOIN
(SELECT MAX(NIVEL) AS MAXNIVEL, IDATA FROM METRICAS WHERE IDATA = (SELECT MAX(IDATA) FROM METRICAS)) MM
ON M.IDATA = MM.IDATA
AND M.NIVEL = MM.MAXNIVEL;

# 2) Qual o endereço do usuário chamado José?
# Pode-se encontrar o endereço da empresa em que José trabalha ao encontrar o
# id da empresa em que José trabalha e consultando seu endereço.
SELECT * FROM ENDERECO WHERE ID_EMPRESA = (SELECT ID_EMPRESA FROM USUARIO WHERE NOME = 'José');
# Caso haja outro usuário com nome José, deve-se fazer a consulta utilizando o ID do usuário
#SELECT * FROM ENDERECO WHERE ID_EMPRESA = (SELECT ID_EMPRESA FROM USUARIO WHERE ID = 9);

# 3) Quantos incidentes ocorreram na empresa X?
# Utilizando COUNT(*) pode-se saber quantos incidentes ocorreram na empresa indicada
SELECT COUNT(*) AS "Quantidade de Incidentes na Empresa X" FROM INCIDENTES WHERE ID_EMPRESA = (SELECT ID FROM EMPRESA WHERE NOMEFANTASIA='X');
# Caso não saiba o nome fantasia da empresa, pode-se encontrar pelo ID da empresa
#SELECT COUNT(*) AS "Quantidade de Incidentes na Empresa X" FROM INCIDENTES WHERE ID_EMPRESA = 1;
